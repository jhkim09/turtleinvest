# 🐢 터틀 트레이딩 수동 등록 시스템

**개발 완료일**: 2025.08.27  
**목적**: 키움 잔고의 터틀 매수 구분 및 자동 추적 관리

## 🎯 해결된 핵심 문제들

### 1. 터틀 매수 기록 구분 문제 ✅
**문제**: 키움 잔고만으로는 터틀 전략 매수인지 일반 매수인지 구분 불가  
**해결책**: Tally 폼 기반 수동 등록 시스템 구축

### 2. N값 동적 업데이트 ✅
**문제**: 터틀 규칙상 N값(ATR)이 매일 변경되어야 하는데 추적 어려움  
**해결책**: `portfolioTracker.js`에서 매일 N값 재계산 및 반영

### 3. 매수/매도 포인트 추적 ✅  
**문제**: 누적 매수 가격대와 손절가를 정확히 알 방법 부족  
**해결책**: DB 기록 기반 완벽한 포지션 추적 시스템

## 🏗️ 시스템 구조

### Tally 폼 (수동 입력)
**URL**: https://tally.so/r/m6gNdJ

**입력 필드들**:
- 종목코드 또는 종목명
- 터틀 매수 신호 유형 (20일/55일 돌파)
- 매수 일자
- 최초 매수가격
- 매수 수량  
- 현재 터틀 단계 (1~4단계)
- 매수 당시 N값 (선택, 없으면 자동 계산)
- 메모 (선택)

### API 엔드포인트들

```javascript
// 터틀 포지션 관리 API
POST /api/turtle-positions/register-from-tally   // Tally 웹훅 수신
GET  /api/turtle-positions/list                  // 키움 동기화 + 포지션 목록
GET  /api/turtle-positions/detail/:symbol        // 특정 종목 상세 정보  
DELETE /api/turtle-positions/remove/:symbol      // 포지션 기록 삭제
```

### 데이터 플로우

```
1. 사용자가 터틀 매수 실행
2. Tally 폼에서 매수 정보 입력
3. Webhook으로 서버에 데이터 전송
4. 자동 N값 계산 및 DB 저장
5. 키움 API 동기화 시 포지션 매칭
6. 실시간 손절가/추가매수가 계산
```

## 📊 핵심 기능들

### 1. 자동 N값 계산
```javascript
// 입력값이 없으면 Yahoo Finance 일봉 데이터로 ATR 계산
const atr = calculateATR(priceData, 20);
console.log(`📊 ${symbol} N값 자동 계산: ${atr}원`);
```

### 2. 종목코드 정규화  
```javascript  
// 키움 API: A122870 → DB 검색: 122870
const normalizedSymbol = symbol.startsWith('A') ? symbol.substring(1) : symbol;
```

### 3. 터틀 포지션 생성
```javascript
const turtlePosition = {
  symbol: '122870',
  originalN: 6265,                    // N값 (ATR)
  currentStopLoss: 91370,             // 손절가 (평균가 - 2N)
  nextAddPrice: 106765,               // 추가매수가 (평균가 + 0.5N)
  riskAmount: 12530,                  // 리스크 금액 (수량 × 2N)
  currentUnits: 1,                    // 현재 터틀 단계
  maxUnits: 4                         // 최대 피라미딩 단계
};
```

## 🔧 구현된 핵심 모듈들

### 1. `routes/turtlePositions.js`
- Tally 웹훅 데이터 파싱
- 종목코드/종목명 변환
- Trade/Signal 모델 저장
- N값 자동 계산

### 2. `services/portfolioTracker.js` (수정)
- 종목코드 정규화 함수 추가
- 터틀 기록 기반 포지션 생성
- 키움 잔고와 터틀 기록 매칭

### 3. `services/turtlePyramiding.js`
- 피라미딩 로직 (4단계까지)
- 추가매수 신호 계산
- 손절가 업데이트

## ✅ 검증된 동작

### 성공적인 터틀 매수 기록 등록
```
📝 Tally 터틀 매수 기록 수신: 122870
📊 122870 N값 자동 계산: 6265원  
✅ 터틀 매수 기록 등록 완료: 122870 1단계
```

### 키움 잔고와 매칭 확인
```
🔍 터틀 이력 확인: A122870 → 122870
✅ A122870: 터틀 매수 이력 확인됨 (거래 5개, 신호 4개)
📊 122870: 터틀 기록 N값 = 6265원
```

## 📈 실제 투자 예시

**와이지엔터테인먼트 (122870) 터틀 포지션**:
- **매수가**: 103,900원
- **N값**: 6,265원
- **손절가**: 91,370원 (매수가 - 2N)  
- **다음 추가매수**: 107,032원 (매수가 + 0.5N)
- **리스크**: 12,530원 (1주 × 2N)

## 🚀 운영 방법

### 터틀 매수 시
1. **실제 매수 실행** (키움 HTS 등)
2. **Tally 폼 입력**: https://tally.so/r/m6gNdJ
3. **자동 처리**: N값 계산 → DB 저장 → 포지션 추적

### 일일 관리
- **키움 동기화**: `/api/turtle-positions/list` 호출
- **N값 업데이트**: 매일 자동 재계산
- **추가매수 모니터링**: 현재가가 추가매수가에 도달 시 알림

## 🎉 시스템 완성도

- ✅ **수동 등록**: Tally 폼으로 간편 입력
- ✅ **자동 계산**: N값, 손절가, 추가매수가
- ✅ **실시간 추적**: 키움 잔고와 완벽 동기화  
- ✅ **리스크 관리**: 터틀 규칙 완벽 준수
- ✅ **확장성**: 종목 수 제한 없음

---

**🎯 결론**: 터틀 트레이딩 전략을 완벽하게 디지털화하여, 기억력에 의존하지 않고 체계적으로 관리할 수 있는 시스템 완성!